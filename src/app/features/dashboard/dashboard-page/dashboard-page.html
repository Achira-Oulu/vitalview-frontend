  <!-- Top navigation bar -->
  <header class="w-full border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl bg-rose-500 flex items-center justify-center text-white font-semibold">
          V
        </div>
        <div class="flex flex-col">
          <span class="font-semibold text-slate-800">VitalView</span>
          <span class="text-xs text-slate-500">Health metrics dashboard</span>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <span class="text-xs text-slate-500 hidden sm:block">
          Prototype · Angular 21 · NestJS
        </span>
        <button
          type="button"
          class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100"
          (click)="logout()"
        >
          Logout
        </button>
      </div>
    </div>
  </header>

  <main class="min-h-screen bg-slate-50">
    <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

      <!-- File analysis upload card -->
      <section class="rounded-xl bg-white shadow-sm border border-slate-100 p-4 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-sm font-semibold text-slate-800">
              Analyze a .001 recording
            </h2>
            <p class="text-xs text-slate-500">
              Upload a raw session file and fetch the processed JSON from the analysis backend.
            </p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
          <input
            type="file"
            accept=".001"
            (change)="onFileSelected($event)"
            class="text-sm"
          />

          <button
            type="button"
            class="px-3 py-1.5 rounded-lg text-sm bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="
              !selectedFile ||
              analysisStatus() === 'uploading' ||
              analysisStatus() === 'processing'
            "
            (click)="analyzeSelectedFile()"
          >
            @if (analysisStatus() === 'uploading' || analysisStatus() === 'processing') {
              Analyzing…
            } @else {
              Analyze file
            }
          </button>
        </div>

        @if (analysisMessage()) {
          <p class="text-xs"
            [class.text-slate-600]="analysisStatus() !== 'error'"
            [class.text-rose-600]="analysisStatus() === 'error'">
            {{ analysisMessage() }}
          </p>
        }

        @if (analysisResult) {
          <div class="mt-3 border-t border-slate-200 pt-3">
            <p class="text-xs font-semibold text-slate-700 mb-1">
              Raw analysis JSON (preview)
            </p>
            <pre class="text-[11px] bg-slate-50 rounded p-2 overflow-auto max-h-64">
      {{ analysisResult | json }}
            </pre>
          </div>
        }
      </section>


      <!-- Metrics tabs -->
      <section>
        <nav class="flex gap-2 border-b border-slate-200 pb-2">
          @for (tab of metricTabs; track tab.id) {
            <button
              type="button"
              (click)="onSelectMetric(tab.id)"
              class="px-3 py-1.5 rounded-full text-sm border transition hover:bg-slate-100"
              [class.bg-slate-900]="selectedMetricId() === tab.id"
              [class.text-white]="selectedMetricId() === tab.id"
              [class.border-slate-900]="selectedMetricId() === tab.id"
              [class.bg-slate-100]="selectedMetricId() !== tab.id"
              [class.text-slate-700]="selectedMetricId() !== tab.id"
              [class.border-slate-200]="selectedMetricId() !== tab.id"
            >
              {{ tab.label }}
            </button>
          }
        </nav>
      </section>

      <!-- Loading / error -->
      @if (loading()) {
        <p class="text-slate-500 text-sm">Loading metrics…</p>
      }

      @if (error()) {
        <p class="text-red-500 text-sm">{{ error() }}</p>
      }

      <!-- Dashboard content -->
      @if (!loading()) {

        <!-- Summary cards -->
        <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          @for (tab of metricTabs; track tab.id) {
            @let data = metrics()[tab.id];

            <article
              class="rounded-xl bg-white shadow-sm border border-slate-100 p-4 flex flex-col gap-1"
            >
              <h2 class="text-sm font-semibold text-slate-800">
                {{ tab.label }}
              </h2>

              <p class="text-xs text-slate-500">
                @if (data?.description) {
                  {{ data.description }}
                } @else {
                  No description
                }
              </p>

              <div class="mt-2 flex items-baseline gap-1">
                @let avg = getTrendAverage(data);

                @if (avg !== null) {
                  <span class="text-lg font-semibold text-slate-900">
                    {{ avg | number:'1.0-1' }}
                  </span>
                } @else {
                  <span class="text-lg font-semibold text-slate-400">
                    –
                  </span>
                }

                <span class="text-xs text-slate-500">
                  @if (tab.id === 'heartrate') {
                    bpm
                  } @else if (tab.id === 'brainPulsatility') {
                    %
                  } @else {
                    index
                  }
                </span>
              </div>

              <p class="text-[11px] text-slate-400 mt-1">
                @if (data?.measurements?.length) {
                  {{ data.measurements.length }} samples
                } @else {
                  No samples
                }
              </p>
            </article>
          }
        </section>

        <!-- Selected metric chart & details -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
          <!-- Chart block -->
          <div class="lg:col-span-2 rounded-xl bg-white shadow-sm border border-slate-100 p-4">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="text-sm font-semibold text-slate-800">
                  {{ currentTab().label }} – time series
                </h2>
                <p class="text-xs text-slate-500">
                  @if (currentMetric()?.description) {
                    {{ currentMetric().description }}
                  } @else {
                    Detailed view
                  }
                </p>
              </div>
            </div>

            <div class="mt-2 overflow-x-auto">
              <div class="relative h-[320px] w-full">
                <canvas id="metricChart" class="w-full h-full"></canvas>
              </div>
            </div>
          </div>

          <!-- Stat block -->
          <div class="rounded-xl bg-white shadow-sm border border-slate-100 p-4 space-y-3">
            <h2 class="text-sm font-semibold text-slate-800">
              {{ currentTab().label }} summary
            </h2>

            @if (currentMetric()) {
              <div class="space-y-2 text-sm text-slate-700">
                <p>
                  <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                    Samples
                  </span><br />
                  {{ currentMetric().measurements?.length ?? 0 }}
                </p>

                <p>
                  <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                    Trends
                  </span><br />

                  @let trendEntries = getTrendEntries(selectedMetricId(), currentMetric());

                  @if (trendEntries.length > 0) {
                    <ul class="mt-1 space-y-1 text-sm">
                      @for (entry of trendEntries; track entry.label) {
                        <li class="flex items-baseline justify-between">
                          <span class="text-xs text-slate-500">
                            {{ entry.label }}
                          </span>
                          <span class="text-sm font-medium text-slate-900">
                            {{ entry.value | number:'1.0-1' }}
                            <span class="text-[11px] text-slate-500">{{ entry.unit }}</span>
                          </span>
                        </li>
                      }
                    </ul>
                  } @else {
                    <span class="text-xs text-slate-400">No trends available.</span>
                  }
                </p>
              </div>
            } @else {
              <p class="text-xs text-slate-400">
                No data loaded for this metric yet.
              </p>
            }
          </div>
        </section>
      }
    </div>
  </main>

