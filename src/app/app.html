<!-- <h1>VitalView – Heartrate</h1>

@if (loading()) {
  <p>Loading...</p>
}

@if (error()) {
  <p style="color: red;">{{ error() }}</p>
}

@if (!loading() && heartrate()) {
  <section>
    <p>{{ heartrate()!.description }}</p>

    <p>
      Average heart rate:
      {{ heartrate()!.trends.rate.average | number : '1.0-1' }}
      {{ heartrate()!.units['rate'] ?? 'bpm' }}
    </p>

    <p>
      Average HRV:
      {{ heartrate()!.trends.hrv.average | number : '1.0-1' }}
      {{ heartrate()!.units['hrv'] ?? 'ms' }}
    </p>
  </section>
}

<!-- Canvas is ALWAYS present -->
<!-- <section style="max-width: 800px; margin-top: 1rem;">
  <canvas id="hrChart" width="800" height="400"></canvas>
</section> --> -->


<!-- Top navigation bar -->
<header class="w-full border-b bg-white/80 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 rounded-xl bg-rose-500 flex items-center justify-center text-white font-semibold">
        V
      </div>
      <div class="flex flex-col">
        <span class="font-semibold text-slate-800">VitalView</span>
        <span class="text-xs text-slate-500">Health metrics dashboard</span>
      </div>
    </div>
    <div class="text-xs text-slate-500 hidden sm:block">
      Prototype · Angular 21 · NestJS
    </div>
  </div>
</header>

<main class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

      <!-- Metrics tabs -->
    <section>
      <nav class="inline-flex items-center gap-1 rounded-full bg-slate-100 p-1 border border-slate-200">
        @for (tab of metricTabs; track tab.id) {
          <button
            type="button"
            (click)="onSelectMetric(tab.id)"
            class="px-3 py-1.5 rounded-full text-sm border transition
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-300
                  "
            [class.bg-slate-900]="selectedMetricId() === tab.id"
            [class.text-white]="selectedMetricId() === tab.id"
            [class.border-slate-900]="selectedMetricId() === tab.id"
            [class.bg-transparent]="selectedMetricId() !== tab.id"
            [class.text-slate-700]="selectedMetricId() !== tab.id"
            [class.border-transparent]="selectedMetricId() !== tab.id"
            [class.hover:bg-white]="selectedMetricId() !== tab.id"
          >
            {{ tab.label }}
          </button>
        }
      </nav>
    </section>


    <!-- Loading / error -->
    @if (loading()) {
      <p class="text-slate-500 text-sm">Loading metrics…</p>
    }

    @if (error()) {
      <p class="text-red-500 text-sm">{{ error() }}</p>
    }

    <!-- Dashboard content -->
    @if (!loading()) {

    <!-- Summary cards -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      @for (tab of metricTabs; track tab.id) {
        @let data = metrics()[tab.id];
        @let isActive = selectedMetricId() === tab.id;

        <article
          (click)="onSelectMetric(tab.id)"
          class="rounded-xl bg-white shadow-sm border border-slate-100 p-4 flex flex-col gap-1 cursor-pointer transition
                hover:shadow-md hover:-translate-y-[1px]
                "
          [class.ring-2]="isActive"
          [class.ring-rose-400]="isActive && tab.id === 'heartrate'"
          [class.ring-emerald-400]="isActive && tab.id === 'gindex'"
          [class.ring-indigo-400]="isActive && tab.id === 'brainPulsatility'"
        >
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-slate-800">
              {{ tab.label }}
            </h2>

            <!-- Small status badge -->
            <span
              class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-medium"
              [class.bg-rose-50]="tab.id === 'heartrate'"
              [class.text-rose-600]="tab.id === 'heartrate'"
              [class.bg-emerald-50]="tab.id === 'gindex'"
              [class.text-emerald-600]="tab.id === 'gindex'"
              [class.bg-indigo-50]="tab.id === 'brainPulsatility'"
              [class.text-indigo-600]="tab.id === 'brainPulsatility'"
            >
              <!-- @if (isActive) {
                Viewing
              } @else {
                Available
              } -->
            </span>
          </div>

          <p class="text-xs text-slate-500 line-clamp-2">
            @if (data?.description) {
              {{ data.description }}
            } @else {
              No description
            }
          </p>

          <div class="mt-2 flex items-baseline gap-1">
            @let avg = tab.id === 'gindex'
              ? getGIndexAverage(data)
              : getTrendAverage(data);


            @if (avg !== null) {
              <span class="text-lg font-semibold text-slate-900">
                {{ avg | number:'1.0-1' }}
              </span>
            } @else {
              <span class="text-lg font-semibold text-slate-400">
                –
              </span>
            }

            <span class="text-xs text-slate-500">
              @if (tab.id === 'heartrate') {
                bpm
              } @else if (tab.id === 'brainPulsatility') {
                %
              } @else {
                index
              }
            </span>
          </div>

          <p class="text-[11px] text-slate-400 mt-1">
            @if (data?.measurements?.length) {
              {{ data.measurements.length }} samples
            } @else {
              No samples
            }
          </p>
        </article>
      }
    </section>


      <!-- Selected metric chart & details -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <!-- Chart block -->
        <div class="lg:col-span-2 rounded-xl bg-white shadow-sm border border-slate-100 p-4">
          <!-- <div class="flex items-center justify-between mb-2">
            <div>
              <h2 class="text-sm font-semibold text-slate-800">
                {{ currentTab().label }} – time series
              </h2>
              <p class="text-xs text-slate-500">
                @if (currentMetric()?.description) {
                  {{ currentMetric().description }}
                } @else {
                  Detailed view
                }
              </p>
            </div>
          </div> -->
          <div class="flex items-center justify-between mb-2">
            <div>
              <h2 class="text-sm font-semibold text-slate-800">
                {{ currentTab().label }} – time series
              </h2>
              <p class="text-xs text-slate-500">
                @if (currentMetric()?.description) {
                  {{ currentMetric().description }}
                } @else {
                  Detailed view
                }
              </p>
            </div>

            <div class="flex items-center gap-2">
              <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-[2px] text-[11px] text-slate-600">
                {{ currentMetric()?.measurements?.length ?? 0 }} samples
              </span>
            </div>
          </div>


          <!-- <div class="mt-2">
            <div class="mt-2 overflow-x-auto">
                <div class="relative h-[320px] min-w-[900px] lg:min-w-[1200px]">
                    <canvas id="metricChart" class="w-full h-full"></canvas>
                </div>
            </div>
          </div> -->
            <div class="mt-2 overflow-x-auto">
                <div class="relative h-[320px] w-full">
                    <canvas id="metricChart" class="w-full h-full"></canvas>
                </div>
            </div>

        </div>

        <!-- Stat block -->
        <div class="rounded-xl bg-white shadow-sm border border-slate-100 p-4 space-y-3">
          <h2 class="text-sm font-semibold text-slate-800">
            {{ currentTab().label }} summary
          </h2>

          @if (currentMetric()) {
            <div class="space-y-2 text-sm text-slate-700">
              <p>
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                  Samples
                </span><br />
                {{ currentMetric().measurements?.length ?? 0 }}
              </p>

              <!-- <p>
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                  Trends
                </span><br />
                @if (currentMetric().trends) {
                  <pre class="text-[11px] bg-slate-50 rounded p-2 overflow-auto">
{{ currentMetric().trends | json }}
                  </pre>
                } @else {
                  <span class="text-xs text-slate-400">No trends available.</span>
                }
              </p> -->
                <p>
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                    Trends
                </span><br />

                @let trendEntries = getTrendEntries(selectedMetricId(), currentMetric());

                @if (trendEntries.length > 0) {
                    <!-- <ul class="mt-1 space-y-1 text-sm">
                    @for (entry of trendEntries; track entry.label) {
                        <li class="flex items-baseline justify-between">
                        <span class="text-xs text-slate-500">
                            {{ entry.label }}
                        </span>
                        <span class="text-sm font-medium text-slate-900">
                            {{ entry.value | number:'1.0-1' }}
                            <span class="text-[11px] text-slate-500">{{ entry.unit }}</span>
                        </span>
                        </li>
                    }
                    </ul> -->

                    <ul class="mt-1 space-y-1 text-sm">
                    @for (entry of trendEntries; track entry.label) {
                      <li class="flex items-baseline justify-between">
                        <span class="text-xs text-slate-500">
                          {{ entry.label }}
                        </span>
                        <span class="text-sm font-medium text-slate-900">
                          {{ entry.value | number:'1.0-1' }}
                          <span class="text-[11px] text-slate-500 ml-1">{{ entry.unit }}</span>
                        </span>
                      </li>
                    }
                  </ul>

                } @else {
                    <span class="text-xs text-slate-400">No trends available.</span>
                }
                </p>


            </div>
          } @else {
            <p class="text-xs text-slate-400">
              No data loaded for this metric yet.
            </p>
          }
        </div>
      </section>
    }
  </div>
</main>
